<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Martingala</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
<script type="text/hamltemplate" id="body-tpl">
.container-fluid
  %h1 Martingala
  .row
    .col-xs-6.col-md-3
      .form-group
        %label(for="secret") Secret
        %input#secret.form-control(placeholder="Secret" type="text")

    .col-xs-6.col-md-3
      .form-group
        %label(for="multiplier") Multiplicador
        %input#multiplier.form-control(placeholder="Multiplicador" value="1.5" type="number" min="0" step="0.01")
  .row
    .col-xs-6.col-md-3
      .form-group
        %label(for="stop-loss") Balance mínimo
        %input#stop-loss.form-control(type="number")
    .col-xs-6.col-md-3
      .form-group
        %label(for="streak-reset") Reseteo de racha
        %input#streak-reset.form-control(type="number" min="1")
  .row
    .col-xs-6.col-md-3
      .form-group
        %label(for="initial-bet") Apuesta mínima
        %input#initial-bet.form-control(type="number" min="100" value="100")
    .col-xs-6.col-md-3
      .form-group
        %label(for="min-rolls") Mínima cantidad de tiros
        %input#min-rolls.form-control(type="number" min="9")
  .row
    .col-xs-6.col-md-3
      .form-group
        %button#play.btn.btn-default(type="button")
          %i.glyphicon.glyphicon-play
        %button#stop.btn.btn-default(type="button")
          %i.glyphicon.glyphicon-stop
    .col-xs-6.col-md-3
      .form-group
        %label(for="total-bets") Apostado hasta ahora
        %input#total-bets.form-control(type="number")
  .row
    .col-xs-6.col-md-3
      %span#current-balance
      BTC -
      Max rolls:
      %span#max-rolls
  %br
  %pre#stdout.pre-scrollable.small
</script>

  <body>
    <!-- Underscore.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.string/3.2.3/underscore.string.min.js"></script>
    <script type="text/javascript">_.mixin(s.exports());</script>
    <script src="https://cdn.rawgit.com/uglyog/clientside-haml-js/master/lib/haml.js"></script>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
    <!-- CoffeScript -->
    <script src="http://coffeescript.org/extras/coffee-script.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script type="text/coffeescript">
      $('body').prepend(haml.compileHaml(sourceId: 'body-tpl'))

      document.location.params =
        _.object(document.location.search.replace(/(^\?)/,'').split("&").map( (n) -> n.split("=") ))

      window.r = (v) -> Promise.resolve v
      window.rej = (v) -> Promise.reject v

      String::ljust = (width, padding) ->
        padding = padding || " "
        padding = padding.substr( 0, 1 )
        if @length < width
          @ + padding.repeat(width - @length)
        else
          @

      String::rjust = (width, padding) ->
        padding = padding || " "
        padding = padding.substr( 0, 1 )
        if @length < width
          padding.repeat(width - @length) + @
        else
          @
    </script>
    <script type="text/coffeescript">
      window.puts = ->
        #console.log(arguments...)
        $("#stdout").prepend(_.collect(arguments, (a) -> "#{a}<br/>")...)

      window.Martingala = class Martingala
        constructor: (@secret, @multiplier = 2, @initialBet = @MINBET, @streakReset = 2, @stopLoss, @minRolls) ->
          @multiplier = parseFloat(@multiplier)
          @initialBet = parseInt(@initialBet)
          @streakReset = parseInt(@streakReset)
          @stopLoss = parseInt(@stopLoss)
          @calcOdds()

          @balance = 0
          if @secret
            @updateBalance().then =>
              @recalcInitialBet()
              setInterval(@updateBalance.bind(@), 5000)

        calcOdds: ->
          @rollBelow = Math.floor(@MAXROLL / @multiplier * 0.981)
          @payout = +(@MAXROLL / @rollBelow * 0.981).toFixed(5)

        recalcInitialBet: ->
          return @initialBet unless @minRolls
          minRolls = _.min([ @maxRolls(@MINBET), @minRolls ])
          @initialBet = @MINBET
          @initialBet += 1 until @maxRolls(@initialBet + 1) < minRolls
          $("#initial-bet").val(@initialBet)
          @initialBet

        inspect: ->
          "Roll below: #{@rollBelow} - Chances: #{+(@rollBelow / @MAXROLL * 100).toFixed(3)}% - Max rolls: #{@maxRolls()}"

        run: (@totalBets = 0) ->
          @running = true
          @symmetricStreak = 0
          @startRound().then(@placeBet.bind(@))

        stop: -> @running = false

        placeBet: ->
          @calculateBet()
          if @stopLoss
            return if (@balance - @bet) < @stopLoss
          @placebet(@bet, @rollBelow)
            .then(=>
              @totalBets += @bet
              $("#total-bets").val(@totalBets)

              [ one, two, three ] = @lastGame['message'].split(' ')
              message = [ one.ljust(8), two.rjust(12), three ].join(' ')
              puts "#{message} - Bet was: #{@bet.toString().rjust 8} - #{moment().format("YYYY/MM/DD HH:mm:ss")} - Total so far: #{@totalBets}"

              return if !@running && @lastGameWon()
              @prepareNextRound()
              @placeBet())
            .catch((error) =>
              puts "ERROR! - #{JSON.stringify error}"
              if @lastGameFailed()
                return if @lastGame.failcode == 19
              @startRound().then(@placeBet.bind(@))
            )

        calculateBet: ->
          @bet = _.max([ @neededBet(@totalBets), @MINBET ])

        neededBet: (amount, minBet = @initialBet) ->
          #_.max([ Math.ceil( ( amount + minBet ) / ( @multiplier - 1 ) ), minBet ])
          _.max([ Math.ceil( ( amount ) / ( @multiplier - 1 ) ), minBet ])

        prepareNextRound: ->
          if @lastGameWon()
            @totalBets = if @symmetricStreak >= @streakReset
              @recalcInitialBet()
              @symmetricStreak = 0
            else
              @symmetricStreak -= 1 if @symmetricStreak > 0
              bets = @totalBets - @bet
              #lastBet = Math.floor(( bets + @initialBet) / @multiplier)
              lastBet = Math.floor(( bets ) / @multiplier)
              _.max([ bets - _.max([ lastBet, @MINBET, @initialBet ]), 0 ])
          else
            @symmetricStreak += 1

        maxRolls: (minBet) ->
          count = 0
          total = 0
          loop
            bet = @neededBet(total, minBet)
            total += bet
            break if total > @balance
            #puts "Bet: #{bet} - Total: #{total}"
            count += 1
          count

        MAXROLL: 65536.0
        MINBET: 100

        updateBalance: (force) ->
          diff = Date.now() - ( @lastBalanceAt || 0 )
          return r(@balance) unless force || diff >= 3000
          @call('userbalance').then(@setBalance.bind(@))

        setBalance: (b) ->
          @lastBalanceAt = Date.now()
          @balance = b['userBalanceInSatoshis'] || b['balanceInSatoshis']
          $("#current-balance").text(@balance / 100000000)
          $("#max-rolls").text(@maxRolls())
          @balance

        startRound: ->
          @call('startround').then((@round) =>)

        placebet: (bet, rollBelow, clientRoll = 3245,
          id = @round['id'], serverHash = @round['hash']) ->
          @call('placebet', betInSatoshis: bet, id: id, serverHash: serverHash, clientRoll: clientRoll, belowRollToWin: rollBelow)
            .then((@lastGame) =>
              return rej(@lastGame) if @lastGameFailed()
              @setBalance(@lastGame)
              @round = @lastGame['nextRound']
              @lastGame
            )

        lastGameStatus: ->
          return 'empty' unless @lastGame
          return 'failed' if @lastGame['status'] == 'fail'
          return 'won' if @lastGame['bet']['result'] == 'win'
          'lost'

        lastGameFailed: ->
          @lastGameStatus() == 'failed'

        lastGameWon: ->
          @lastGameStatus() == 'won'

        lastGameLost: ->
          @lastGameStatus() == 'lost'

        streak: ->
          @lastGame['bet']['streak']

        call: (method, params = { }) ->
          jqXHR = $.ajax(
            url: "https://session.satoshidice.com/userapi/#{method}"
            data: $.extend({ secret: @secret }, params)
            dataType: 'jsonp')
          Promise.resolve(jqXHR)

    </script>
    <script type="text/coffeescript">
      martingala = undefined
      keys = [ 'multiplier', 'initial-bet', 'streak-reset', 'stop-loss', 'min-rolls' ]
      $ ->
        args = _.collect [ 'secret', keys... ], (k) ->
          v = location.params[k]
          $("##{k}").val(v) if v
          $("##{k}").val()

        martingala = new Martingala(args...)
        _.each keys, (k) ->
          $("##{k}").change ->
            martingala[_.camelcase(k)] = +$(@).val()
            martingala.calcOdds()
            puts martingala.inspect()

        $secret = $("#secret").change(->
          martingala.secret = $(@).val()
          martingala.updateBalance(true).then(->
            puts martingala.inspect()
          ).catch -> puts "ERROR - #{JSON.stringify arguments}"
        )
        $secret.change() if $secret.val()

        $("#play").click ->
          $("input").attr('disabled', true)
          martingala.run(parseInt($("#total-bets").val() || 0))

        $("#stop").click ->
          martingala.stop()
          $("input").attr('disabled', false)
    </script>
  </body>
</html>
